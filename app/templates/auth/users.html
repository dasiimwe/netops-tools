{% extends "base.html" %}

{% block title %}User Management - Network Device Manager{% endblock %}

{% block extra_css %}
<style>
    /* Action Buttons */
    .action-toolbar .btn {
        border-radius: 0.375rem;
        font-weight: 500;
        font-size: 0.875rem;
        padding: 0.35rem 0.75rem;
        transition: all 0.2s ease;
    }

    .action-toolbar .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.12);
    }

    /* Filter Card */
    .filter-card {
        border-radius: 0.75rem;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        margin-bottom: 1rem;
        transition: box-shadow 0.3s ease;
    }

    .filter-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .filter-card .card-body {
        padding: 0.85rem;
    }

    /* Table Card */
    .table-card {
        border-radius: 0.75rem;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }

    /* Table Styling */
    .table-card table thead th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        font-weight: 600;
        font-size: 0.75rem;
        color: #495057;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        padding: 0.6rem 0.5rem;
        border-bottom: 2px solid #dee2e6;
    }

    .table-card table tbody td {
        padding: 0.5rem;
        vertical-align: middle;
        font-size: 0.875rem;
    }

    .table-card table tbody tr {
        transition: background-color 0.2s ease;
    }

    .table-card table tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    /* Badges */
    .badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-weight: 500;
        font-size: 0.75rem;
    }

    /* Action Button Group */
    .btn-group-sm .btn {
        border-radius: 0.25rem;
        transition: all 0.2s ease;
        padding: 0.25rem 0.5rem;
        font-size: 0.8125rem;
    }

    .btn-group-sm .btn:hover {
        transform: scale(1.03);
    }

    /* Form Controls */
    .filter-card .form-control,
    .filter-card .form-select {
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }

    .filter-card .form-control:focus,
    .filter-card .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.15);
    }

    .filter-card .form-label {
        font-size: 0.8125rem;
        margin-bottom: 0.25rem;
    }

    /* Pagination */
    .pagination .page-link {
        border-radius: 0.375rem;
        margin: 0 0.15rem;
        border: 1px solid #dee2e6;
        transition: all 0.2s ease;
        padding: 0.35rem 0.65rem;
        font-size: 0.875rem;
    }

    .pagination .page-link:hover {
        background-color: #0d6efd;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .pagination .page-item.active .page-link {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        border-color: #0d6efd;
    }

    /* Sortable Headers */
    .sortable {
        cursor: pointer;
        user-select: none;
    }

    .sortable:hover {
        background-color: #e9ecef;
    }

    .sortable i {
        font-size: 0.7em;
        opacity: 0.6;
    }

    .sortable[data-sort="{{ sort_by }}"] i {
        opacity: 1;
        color: #0d6efd;
    }

    /* Info Cards */
    .info-card {
        border-radius: 0.75rem;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        transition: box-shadow 0.3s ease;
    }

    .info-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .info-card .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
        border-radius: 0.75rem 0.75rem 0 0 !important;
        padding: 0.75rem 1rem;
        font-weight: 600;
        font-size: 0.95rem;
        color: #495057;
    }

    .info-card .card-body {
        padding: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Action Toolbar -->
<div class="action-toolbar mb-3">
    <div class="btn-toolbar">
        <div class="btn-group me-2">
            <a href="{{ url_for('auth.register') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-person-plus"></i> Add User
            </a>
        </div>
    </div>
</div>

<!-- Search and Filters -->
<div class="card filter-card">
    <div class="card-body">
        <form method="GET" id="filterForm">
            <div class="row g-3">
                <!-- Search -->
                <div class="col-md-4">
                    <label for="search" class="form-label">Search</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="search" name="search"
                               value="{{ search }}" placeholder="Search username or email...">
                        <button class="btn btn-outline-secondary" type="submit" id="searchBtn">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>

                <!-- Status Filter -->
                <div class="col-md-2">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status" onchange="submitForm()">
                        <option value="">All Status</option>
                        <option value="active" {{ 'selected' if status_filter == 'active' }}>Active</option>
                        <option value="inactive" {{ 'selected' if status_filter == 'inactive' }}>Inactive</option>
                    </select>
                </div>

                <!-- Role Filter -->
                <div class="col-md-2">
                    <label for="role" class="form-label">Role</label>
                    <select class="form-select" id="role" name="role" onchange="submitForm()">
                        <option value="">All Roles</option>
                        <option value="admin" {{ 'selected' if role_filter == 'admin' }}>Admin</option>
                        <option value="user" {{ 'selected' if role_filter == 'user' }}>User</option>
                    </select>
                </div>

                <!-- Auth Type Filter -->
                <div class="col-md-2">
                    <label for="auth_type" class="form-label">Auth Type</label>
                    <select class="form-select" id="auth_type" name="auth_type" onchange="submitForm()">
                        <option value="">All Types</option>
                        <option value="local" {{ 'selected' if auth_type_filter == 'local' }}>Local</option>
                        <option value="tacacs" {{ 'selected' if auth_type_filter == 'tacacs' }}>TACACS+</option>
                    </select>
                </div>

                <!-- Per Page -->
                <div class="col-md-2">
                    <label for="per_page" class="form-label">Show</label>
                    <select class="form-select" id="per_page" name="per_page" onchange="submitForm()">
                        <option value="5" {{ 'selected' if per_page == 5 }}>5</option>
                        <option value="10" {{ 'selected' if per_page == 10 }}>10</option>
                        <option value="25" {{ 'selected' if per_page == 25 }}>25</option>
                        <option value="50" {{ 'selected' if per_page == 50 }}>50</option>
                        <option value="100" {{ 'selected' if per_page == 100 }}>100</option>
                    </select>
                </div>
            </div>

            <!-- Hidden fields for maintaining state -->
            <input type="hidden" name="sort_by" value="{{ sort_by }}">
            <input type="hidden" name="sort_order" value="{{ sort_order }}">
            <input type="hidden" name="page" value="1">

            <div class="row mt-3">
                <div class="col-12">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Clear Filters
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Results Info -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <small class="text-muted">
            Showing {{ pagination.items|length }} of {{ pagination.total }} users
            {% if search or status_filter or role_filter or auth_type_filter %}
            (filtered)
            {% endif %}
        </small>
    </div>
    <div>
        <small class="text-muted">
            Page {{ pagination.page }} of {{ pagination.pages }}
        </small>
    </div>
</div>

<!-- Users Table -->
<div class="table-card">
    <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
        <thead>
            <tr>
                <th class="sortable" data-sort="username">
                    Username
                    <i class="bi bi-chevron-{{ 'up' if sort_by == 'username' and sort_order == 'asc' else 'down' if sort_by == 'username' and sort_order == 'desc' else 'expand' }}"></i>
                </th>
                <th class="sortable" data-sort="email">
                    Email
                    <i class="bi bi-chevron-{{ 'up' if sort_by == 'email' and sort_order == 'asc' else 'down' if sort_by == 'email' and sort_order == 'desc' else 'expand' }}"></i>
                </th>
                <th class="sortable" data-sort="auth_type">
                    Auth Type
                    <i class="bi bi-chevron-{{ 'up' if sort_by == 'auth_type' and sort_order == 'asc' else 'down' if sort_by == 'auth_type' and sort_order == 'desc' else 'expand' }}"></i>
                </th>
                <th class="sortable" data-sort="is_admin">
                    Role
                    <i class="bi bi-chevron-{{ 'up' if sort_by == 'is_admin' and sort_order == 'asc' else 'down' if sort_by == 'is_admin' and sort_order == 'desc' else 'expand' }}"></i>
                </th>
                <th class="sortable" data-sort="is_active">
                    Status
                    <i class="bi bi-chevron-{{ 'up' if sort_by == 'is_active' and sort_order == 'asc' else 'down' if sort_by == 'is_active' and sort_order == 'desc' else 'expand' }}"></i>
                </th>
                <th class="sortable" data-sort="created_at">
                    Created
                    <i class="bi bi-chevron-{{ 'up' if sort_by == 'created_at' and sort_order == 'asc' else 'down' if sort_by == 'created_at' and sort_order == 'desc' else 'expand' }}"></i>
                </th>
                <th class="sortable" data-sort="last_login">
                    Last Login
                    <i class="bi bi-chevron-{{ 'up' if sort_by == 'last_login' and sort_order == 'asc' else 'down' if sort_by == 'last_login' and sort_order == 'desc' else 'expand' }}"></i>
                </th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>
                    <strong>{{ user.username }}</strong>
                    {% if user.id == current_user.id %}
                    <span class="badge bg-info ms-1">You</span>
                    {% endif %}
                </td>
                <td>{{ user.email or '-' }}</td>
                <td>
                    <span class="badge bg-secondary">{{ user.auth_type|title }}</span>
                </td>
                <td>
                    {% if user.is_admin %}
                    <span class="badge bg-warning">Admin</span>
                    {% else %}
                    <span class="badge bg-primary">User</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.is_active %}
                    <span class="badge bg-success">Active</span>
                    {% else %}
                    <span class="badge bg-danger">Inactive</span>
                    {% endif %}
                </td>
                <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else '-' }}</td>
                <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="{{ url_for('auth.edit_user', user_id=user.id) }}"
                           class="btn btn-outline-primary" title="Edit User">
                            <i class="bi bi-pencil"></i>
                        </a>

                        {% if user.id != current_user.id %}
                        <form method="POST" action="{{ url_for('auth.toggle_user_status', user_id=user.id) }}"
                              style="display: inline;">
                            <button type="submit"
                                    class="btn btn-outline-{% if user.is_active %}warning{% else %}success{% endif %}"
                                    title="{% if user.is_active %}Deactivate{% else %}Activate{% endif %} User"
                                    onclick="return confirm('Are you sure you want to {% if user.is_active %}deactivate{% else %}activate{% endif %} this user?');">
                                <i class="bi bi-{% if user.is_active %}pause{% else %}play{% endif %}"></i>
                            </button>
                        </form>

                        {% if not (user.is_admin and admin_users <= 1) %}
                        <form method="POST" action="{{ url_for('auth.delete_user', user_id=user.id) }}"
                              style="display: inline;"
                              onsubmit="return confirm('Are you sure you want to delete user {{ user.username }}? This action cannot be undone.');">
                            <button type="submit" class="btn btn-outline-danger" title="Delete User">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                        {% endif %}
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="bi bi-people h1 d-block text-muted mb-2"></i>
                    {% if search or status_filter or role_filter or auth_type_filter %}
                    No users found matching your filters.
                    <br><small>Try adjusting your search criteria or clearing filters.</small>
                    {% else %}
                    No users found.
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>

<!-- Pagination -->
{% if pagination.pages > 1 %}
<nav aria-label="User pagination">
    <ul class="pagination justify-content-center">
        <!-- First page -->
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('auth.users', page=1, search=search, sort_by=sort_by, sort_order=sort_order, status=status_filter, role=role_filter, auth_type=auth_type_filter, per_page=per_page) }}">
                <i class="bi bi-chevron-double-left"></i>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" href="{{ url_for('auth.users', page=pagination.prev_num, search=search, sort_by=sort_by, sort_order=sort_order, status=status_filter, role=role_filter, auth_type=auth_type_filter, per_page=per_page) }}">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link"><i class="bi bi-chevron-double-left"></i></span>
        </li>
        <li class="page-item disabled">
            <span class="page-link"><i class="bi bi-chevron-left"></i></span>
        </li>
        {% endif %}

        <!-- Page numbers -->
        {% for page_num in pagination.iter_pages() %}
        {% if page_num %}
        {% if page_num != pagination.page %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('auth.users', page=page_num, search=search, sort_by=sort_by, sort_order=sort_order, status=status_filter, role=role_filter, auth_type=auth_type_filter, per_page=per_page) }}">
                {{ page_num }}
            </a>
        </li>
        {% else %}
        <li class="page-item active">
            <span class="page-link">{{ page_num }}</span>
        </li>
        {% endif %}
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">…</span>
        </li>
        {% endif %}
        {% endfor %}

        <!-- Last page -->
        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('auth.users', page=pagination.next_num, search=search, sort_by=sort_by, sort_order=sort_order, status=status_filter, role=role_filter, auth_type=auth_type_filter, per_page=per_page) }}">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" href="{{ url_for('auth.users', page=pagination.pages, search=search, sort_by=sort_by, sort_order=sort_order, status=status_filter, role=role_filter, auth_type=auth_type_filter, per_page=per_page) }}">
                <i class="bi bi-chevron-double-right"></i>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link"><i class="bi bi-chevron-right"></i></span>
        </li>
        <li class="page-item disabled">
            <span class="page-link"><i class="bi bi-chevron-double-right"></i></span>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Statistics Cards -->
<div class="mt-3">
    <div class="row">
        <div class="col-md-6">
            <div class="card info-card">
                <div class="card-header">
                    <i class="bi bi-bar-chart"></i> User Statistics
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h3 text-primary">{{ total_users }}</div>
                                <div class="small text-muted">Total Users</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h3 text-warning">{{ admin_users }}</div>
                                <div class="small text-muted">Admin Users</div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h3 text-success">{{ active_users }}</div>
                                <div class="small text-muted">Active Users</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h3 text-secondary">{{ tacacs_users }}</div>
                                <div class="small text-muted">TACACS+ Users</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card info-card">
                <div class="card-header">
                    <i class="bi bi-shield-check"></i> Security Notes
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="bi bi-shield-check text-success"></i>
                            Local user passwords are securely hashed
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-key text-info"></i>
                            TACACS+ users authenticate externally
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-journal-text text-warning"></i>
                            All user actions are audit logged
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-person-x text-danger"></i>
                            Cannot delete the last admin user
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-submit form when filters change
function submitForm() {
    document.getElementById('filterForm').submit();
}

// Clear all filters
function clearFilters() {
    window.location.href = '{{ url_for("auth.users") }}';
}

// Handle sortable column clicks
document.addEventListener('DOMContentLoaded', function() {
    const sortableHeaders = document.querySelectorAll('.sortable');

    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const sortBy = this.getAttribute('data-sort');
            const currentSortBy = '{{ sort_by }}';
            const currentSortOrder = '{{ sort_order }}';

            let newSortOrder = 'asc';
            if (sortBy === currentSortBy && currentSortOrder === 'asc') {
                newSortOrder = 'desc';
            }

            // Update hidden form fields
            document.querySelector('input[name="sort_by"]').value = sortBy;
            document.querySelector('input[name="sort_order"]').value = newSortOrder;
            document.querySelector('input[name="page"]').value = '1'; // Reset to page 1

            // Submit form
            document.getElementById('filterForm').submit();
        });
    });

    // Handle search on Enter key
    document.getElementById('search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.querySelector('input[name="page"]').value = '1'; // Reset to page 1
            document.getElementById('filterForm').submit();
        }
    });
});
</script>
{% endblock %}