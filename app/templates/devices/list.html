{% extends "base.html" %}

{% block title %}Devices - Network Device Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('devices.add_device') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-circle"></i> Add Device
            </a>
            <a href="{{ url_for('devices.bulk_import') }}" class="btn btn-sm btn-info">
                <i class="bi bi-cloud-upload"></i> Bulk Import
            </a>
            <button type="button" class="btn btn-sm btn-success" onclick="bulkCollect()">
                <i class="bi bi-arrow-repeat"></i> Bulk Collect
            </button>
        </div>
        <div class="btn-group me-2">
            <a href="{{ url_for('devices.export_csv') }}" class="btn btn-sm btn-outline-success">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export CSV
            </a>
            <a href="{{ url_for('devices.export_json') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-download"></i> Export JSON
            </a>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-sm btn-warning" onclick="showBulkCredentialModal()" disabled id="bulkCredentialBtn">
                <i class="bi bi-key"></i> Bulk Assign Credentials
            </button>
            <button type="button" class="btn btn-sm btn-info" onclick="showBulkVendorModal()" disabled id="bulkVendorBtn">
                <i class="bi bi-pencil-square"></i> Bulk Edit Vendor
            </button>
        </div>
    </div>
</div>

<!-- Search and Filters -->
<div class="card mb-3">
    <div class="card-body">
        <form method="GET" id="filterForm">
            <div class="row g-3">
                <!-- Search -->
                <div class="col-md-4">
                    <label for="search" class="form-label">Search</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="search" name="search"
                               value="{{ search }}" placeholder="Search hostname or IP...">
                        <button class="btn btn-outline-secondary" type="submit" id="searchBtn">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>

                <!-- Vendor Filter -->
                <div class="col-md-2">
                    <label for="vendor" class="form-label">Vendor</label>
                    <select class="form-select" id="vendor" name="vendor" onchange="submitForm()">
                        <option value="">All Vendors</option>
                        {% for vendor in vendors %}
                        <option value="{{ vendor }}" {{ 'selected' if vendor_filter == vendor }}>
                            {{ vendor|replace('_', ' ')|title }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Status Filter -->
                <div class="col-md-2">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status" onchange="submitForm()">
                        <option value="">All Status</option>
                        <option value="reachable" {{ 'selected' if status_filter == 'reachable' }}>Reachable</option>
                        <option value="unreachable" {{ 'selected' if status_filter == 'unreachable' }}>Unreachable</option>
                    </select>
                </div>

                <!-- Group Filter -->
                <div class="col-md-2">
                    <label for="group" class="form-label">Group</label>
                    <select class="form-select" id="group" name="group" onchange="submitForm()">
                        <option value="">All Groups</option>
                        {% for group in groups %}
                        <option value="{{ group.id }}" {{ 'selected' if group_filter == group.id }}>{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Per Page -->
                <div class="col-md-2">
                    <label for="per_page" class="form-label">Show</label>
                    <select class="form-select" id="per_page" name="per_page" onchange="submitForm()">
                        <option value="5" {{ 'selected' if per_page == 5 }}>5</option>
                        <option value="10" {{ 'selected' if per_page == 10 }}>10</option>
                        <option value="25" {{ 'selected' if per_page == 25 }}>25</option>
                        <option value="50" {{ 'selected' if per_page == 50 }}>50</option>
                        <option value="100" {{ 'selected' if per_page == 100 }}>100</option>
                    </select>
                </div>
            </div>

            <!-- Hidden fields for maintaining state -->
            <input type="hidden" name="sort_by" value="{{ sort_by }}">
            <input type="hidden" name="sort_order" value="{{ sort_order }}">
            <input type="hidden" name="page" value="1">

            <div class="row mt-3">
                <div class="col-12">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Clear Filters
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Results Info and Statistics -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <small class="text-muted">
            Showing {{ pagination.items|length }} of {{ pagination.total }} devices
            {% if search or vendor_filter or status_filter or group_filter %}
            (filtered)
            {% endif %}
        </small>
    </div>
    <div>
        <span class="badge bg-info me-2">Total: {{ total_devices }}</span>
        <span class="badge bg-success me-2">Reachable: {{ reachable_devices }}</span>
        <span class="badge bg-danger">Unreachable: {{ unreachable_devices }}</span>
    </div>
</div>

<!-- Devices Table -->
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAll" onchange="toggleAll(this)"></th>
                <th class="sortable" data-sort="hostname">
                    Hostname
                    <i class="bi bi-chevron-{{ 'up' if sort_by == 'hostname' and sort_order == 'asc' else 'down' if sort_by == 'hostname' and sort_order == 'desc' else 'expand' }}"></i>
                </th>
                <th class="sortable" data-sort="ip_address">
                    IP Address
                    <i class="bi bi-chevron-{{ 'up' if sort_by == 'ip_address' and sort_order == 'asc' else 'down' if sort_by == 'ip_address' and sort_order == 'desc' else 'expand' }}"></i>
                </th>
                <th class="sortable" data-sort="vendor">
                    Vendor
                    <i class="bi bi-chevron-{{ 'up' if sort_by == 'vendor' and sort_order == 'asc' else 'down' if sort_by == 'vendor' and sort_order == 'desc' else 'expand' }}"></i>
                </th>
                <th class="sortable" data-sort="is_reachable">
                    Status
                    <i class="bi bi-chevron-{{ 'up' if sort_by == 'is_reachable' and sort_order == 'asc' else 'down' if sort_by == 'is_reachable' and sort_order == 'desc' else 'expand' }}"></i>
                </th>
                <th>Interfaces</th>
                <th class="sortable" data-sort="last_reachability_check">
                    Last Check
                    <i class="bi bi-chevron-{{ 'up' if sort_by == 'last_reachability_check' and sort_order == 'asc' else 'down' if sort_by == 'last_reachability_check' and sort_order == 'desc' else 'expand' }}"></i>
                </th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for device in devices %}
            <tr>
                <td><input type="checkbox" class="device-checkbox" value="{{ device.id }}"></td>
                <td>
                    <a href="{{ url_for('interfaces.device_interfaces', device_id=device.id) }}">
                        {{ device.hostname }}
                    </a>
                </td>
                <td>{{ device.ip_address }}</td>
                <td>{{ device.vendor|replace('_', ' ')|title }}</td>
                <td>
                    {% if device.is_reachable %}
                    <span class="badge bg-success">Reachable</span>
                    {% else %}
                    <span class="badge bg-danger" title="{{ device.last_error }}">Unreachable</span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge bg-info">{{ device.interfaces.count() }}</span>
                </td>
                <td>
                    {{ device.last_reachability_check.strftime('%Y-%m-%d %H:%M') if device.last_reachability_check else 'Never' }}
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary" title="Collect Interfaces" onclick="collectInterfaces({{ device.id }}, '{{ device.hostname }}')">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                        <button type="button" class="btn btn-outline-info" title="Test Connection" onclick="testDeviceConnection({{ device.id }}, '{{ device.hostname }}')">
                            <i class="bi bi-shield-check"></i>
                        </button>
                        <a href="{{ url_for('devices.edit_device', device_id=device.id) }}" class="btn btn-outline-secondary" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <form method="POST" action="{{ url_for('devices.delete_device', device_id=device.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this device?');">
                            <button type="submit" class="btn btn-outline-danger" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="bi bi-router h1 d-block text-muted mb-2"></i>
                    {% if search or vendor_filter or status_filter or group_filter %}
                    No devices found matching your filters.
                    <br><small>Try adjusting your search criteria or clearing filters.</small>
                    {% else %}
                    No devices found.
                    <br><small><a href="{{ url_for('devices.add_device') }}">Add your first device</a></small>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if pagination.pages > 1 %}
<nav aria-label="Device pagination">
    <ul class="pagination justify-content-center">
        <!-- First page -->
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('devices.list_devices', page=1, search=search, sort_by=sort_by, sort_order=sort_order, vendor=vendor_filter, status=status_filter, group=group_filter, per_page=per_page) }}">
                <i class="bi bi-chevron-double-left"></i>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" href="{{ url_for('devices.list_devices', page=pagination.prev_num, search=search, sort_by=sort_by, sort_order=sort_order, vendor=vendor_filter, status=status_filter, group=group_filter, per_page=per_page) }}">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link"><i class="bi bi-chevron-double-left"></i></span>
        </li>
        <li class="page-item disabled">
            <span class="page-link"><i class="bi bi-chevron-left"></i></span>
        </li>
        {% endif %}

        <!-- Page numbers -->
        {% for page_num in pagination.iter_pages() %}
        {% if page_num %}
        {% if page_num != pagination.page %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('devices.list_devices', page=page_num, search=search, sort_by=sort_by, sort_order=sort_order, vendor=vendor_filter, status=status_filter, group=group_filter, per_page=per_page) }}">
                {{ page_num }}
            </a>
        </li>
        {% else %}
        <li class="page-item active">
            <span class="page-link">{{ page_num }}</span>
        </li>
        {% endif %}
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">…</span>
        </li>
        {% endif %}
        {% endfor %}

        <!-- Last page -->
        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('devices.list_devices', page=pagination.next_num, search=search, sort_by=sort_by, sort_order=sort_order, vendor=vendor_filter, status=status_filter, group=group_filter, per_page=per_page) }}">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" href="{{ url_for('devices.list_devices', page=pagination.pages, search=search, sort_by=sort_by, sort_order=sort_order, vendor=vendor_filter, status=status_filter, group=group_filter, per_page=per_page) }}">
                <i class="bi bi-chevron-double-right"></i>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link"><i class="bi bi-chevron-right"></i></span>
        </li>
        <li class="page-item disabled">
            <span class="page-link"><i class="bi bi-chevron-double-right"></i></span>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Bulk Credential Assignment Modal -->
<div class="modal fade" id="bulkCredentialModal" tabindex="-1" aria-labelledby="bulkCredentialModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkCredentialModalLabel">
                    <i class="bi bi-key"></i> Bulk Assign Credentials
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="bulkCredentialForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>Selected Devices: <span id="selectedDeviceCount">0</span></strong>
                        <ul id="selectedDevicesList" class="list-unstyled mt-2"></ul>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Assignment Type</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="bulk_assignment_type" id="bulk_assignment_none" value="none" checked onchange="toggleBulkCredentialOptions()">
                            <label class="form-check-label" for="bulk_assignment_none">
                                Use Default (Remove any specific assignments)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="bulk_assignment_type" id="bulk_assignment_credential" value="credential" onchange="toggleBulkCredentialOptions()">
                            <label class="form-check-label" for="bulk_assignment_credential">
                                Specific Credential
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="bulk_assignment_type" id="bulk_assignment_pool" value="pool" onchange="toggleBulkCredentialOptions()">
                            <label class="form-check-label" for="bulk_assignment_pool">
                                Credential Pool
                            </label>
                        </div>
                    </div>

                    <div class="mb-3" id="bulk_credential_select" style="display: none;">
                        <label for="bulk_credential_id" class="form-label">Select Credential</label>
                        <select class="form-select" id="bulk_credential_id" name="bulk_credential_id">
                            <option value="">-- Select a credential --</option>
                            {% for credential in available_credentials %}
                            <option value="{{ credential.id }}">
                                {{ credential.name }} ({{ credential.username }} - {{ credential.credential_type }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3" id="bulk_pool_select" style="display: none;">
                        <label for="bulk_credential_pool_id" class="form-label">Select Credential Pool</label>
                        <select class="form-select" id="bulk_credential_pool_id" name="bulk_credential_pool_id">
                            <option value="">-- Select a credential pool --</option>
                            {% for pool in available_pools %}
                            <option value="{{ pool.id }}">
                                {{ pool.name }} ({{ pool.credentials|length }} credentials)
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Warning:</strong> This will replace any existing credential assignments for the selected devices.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-key"></i> Assign Credentials
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Vendor Edit Modal -->
<div class="modal fade" id="bulkVendorModal" tabindex="-1" aria-labelledby="bulkVendorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkVendorModalLabel">
                    <i class="bi bi-pencil-square"></i> Bulk Edit Vendor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="bulkVendorForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>Selected Devices: <span id="selectedVendorDeviceCount">0</span></strong>
                        <ul id="selectedVendorDevicesList" class="list-unstyled mt-2"></ul>
                    </div>

                    <div class="mb-3">
                        <label for="bulk_vendor" class="form-label">Select Vendor</label>
                        <select class="form-select" id="bulk_vendor" name="bulk_vendor" required>
                            <option value="">-- Select a vendor --</option>
                            <option value="cisco_ios">Cisco IOS</option>
                            <option value="cisco_nxos">Cisco NXOS</option>
                            <option value="cisco_iosxr">Cisco IOS-XR</option>
                            <option value="paloalto">Palo Alto</option>
                            <option value="fortigate">FortiGate</option>
                        </select>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Note:</strong> This will update the vendor for all selected devices.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-pencil-square"></i> Update Vendor
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalLabel">
                    <i class="bi bi-arrow-repeat"></i> Collecting Interfaces from <span id="deviceHostname"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Main Status -->
                <div class="mb-3">
                    <strong>Status:</strong> <span id="currentStatus" class="badge bg-info">Starting...</span>
                </div>

                <!-- Current Command -->
                <div class="mb-3" id="currentCommandSection" style="display: none;">
                    <strong>Current Command:</strong>
                    <div class="font-monospace text-muted" id="currentCommand"></div>
                </div>

                <!-- Commands Progress -->
                <div class="mb-3" id="commandsSection" style="display: none;">
                    <strong>Commands:</strong>
                    <div id="commandsList" class="mt-2"></div>
                </div>

                <!-- Results -->
                <div class="mb-3" id="resultsSection" style="display: none;">
                    <strong>Results:</strong>
                    <div class="alert alert-success">
                        Found <span id="interfacesCount">0</span> interfaces with IP addresses.
                    </div>
                </div>

                <!-- Error -->
                <div class="mb-3" id="errorSection" style="display: none;">
                    <div class="alert alert-danger">
                        <strong>Error:</strong> <span id="errorMessage"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeButton">Close</button>
                <button type="button" class="btn btn-primary" id="refreshButton" onclick="refreshPage()" style="display: none;">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Page
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.sortable {
    cursor: pointer;
    user-select: none;
}

.sortable:hover {
    background-color: #f8f9fa;
}

.sortable i {
    font-size: 0.8em;
    opacity: 0.6;
}

.sortable[data-sort="{{ sort_by }}"] i {
    opacity: 1;
    color: #0d6efd;
}

.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
let progressEventSource = null;

// Auto-submit form when filters change
function submitForm() {
    document.getElementById('filterForm').submit();
}

// Clear all filters
function clearFilters() {
    window.location.href = '{{ url_for("devices.list_devices") }}';
}

// Handle sortable column clicks
document.addEventListener('DOMContentLoaded', function() {
    const sortableHeaders = document.querySelectorAll('.sortable');

    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const sortBy = this.getAttribute('data-sort');
            const currentSortBy = '{{ sort_by }}';
            const currentSortOrder = '{{ sort_order }}';

            let newSortOrder = 'asc';
            if (sortBy === currentSortBy && currentSortOrder === 'asc') {
                newSortOrder = 'desc';
            }

            // Update hidden form fields
            document.querySelector('input[name="sort_by"]').value = sortBy;
            document.querySelector('input[name="sort_order"]').value = newSortOrder;
            document.querySelector('input[name="page"]').value = '1'; // Reset to page 1

            // Submit form
            document.getElementById('filterForm').submit();
        });
    });

    // Handle search on Enter key
    document.getElementById('search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.querySelector('input[name="page"]').value = '1'; // Reset to page 1
            document.getElementById('filterForm').submit();
        }
    });

    // Update button states when checkboxes change
    document.addEventListener('change', function(event) {
        if (event.target.classList.contains('device-checkbox') || event.target.id === 'selectAll') {
            updateBulkButtons();
        }
    });

    // Handle bulk credential form submission
    document.getElementById('bulkCredentialForm').addEventListener('submit', function(e) {
        e.preventDefault();

        var assignmentType = document.querySelector('input[name="bulk_assignment_type"]:checked').value;
        var credentialId = document.getElementById('bulk_credential_id').value;
        var poolId = document.getElementById('bulk_credential_pool_id').value;

        // Validate selection
        if (assignmentType === 'credential' && !credentialId) {
            alert('Please select a credential');
            return;
        }

        if (assignmentType === 'pool' && !poolId) {
            alert('Please select a credential pool');
            return;
        }

        var checkboxes = document.querySelectorAll('.device-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('No devices selected');
            return;
        }

        // Create form and submit
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("devices.bulk_assign_credentials") }}';

        // Add assignment type
        var assignmentInput = document.createElement('input');
        assignmentInput.type = 'hidden';
        assignmentInput.name = 'assignment_type';
        assignmentInput.value = assignmentType;
        form.appendChild(assignmentInput);

        // Add credential or pool id
        if (assignmentType === 'credential' && credentialId) {
            var credInput = document.createElement('input');
            credInput.type = 'hidden';
            credInput.name = 'credential_id';
            credInput.value = credentialId;
            form.appendChild(credInput);
        } else if (assignmentType === 'pool' && poolId) {
            var poolInput = document.createElement('input');
            poolInput.type = 'hidden';
            poolInput.name = 'credential_pool_id';
            poolInput.value = poolId;
            form.appendChild(poolInput);
        }

        // Add device IDs
        checkboxes.forEach(function(checkbox) {
            var deviceInput = document.createElement('input');
            deviceInput.type = 'hidden';
            deviceInput.name = 'device_ids[]';
            deviceInput.value = checkbox.value;
            form.appendChild(deviceInput);
        });

        document.body.appendChild(form);
        form.submit();
    });
});

function toggleAll(source) {
    var checkboxes = document.querySelectorAll('.device-checkbox');
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = source.checked;
    }
    updateBulkButtons();
}

function collectInterfaces(deviceId, hostname) {
    // Start progress collection
    fetch(`/devices/${deviceId}/collect-progress`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.progress_enabled) {
            // Show progress modal and start listening for updates
            showProgressModal(hostname, data.session_id);
        } else {
            // Fallback to regular collection
            window.location.href = `/devices/${deviceId}/collect`;
        }
    })
    .catch(error => {
        console.error('Error starting collection:', error);
        alert('Error starting interface collection');
    });
}

function showProgressModal(hostname, sessionId) {
    // Setup modal
    document.getElementById('deviceHostname').textContent = hostname;
    document.getElementById('currentStatus').textContent = 'Starting...';
    document.getElementById('currentStatus').className = 'badge bg-info';

    // Hide all sections initially
    document.getElementById('currentCommandSection').style.display = 'none';
    document.getElementById('commandsSection').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('errorSection').style.display = 'none';
    document.getElementById('refreshButton').style.display = 'none';

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('progressModal'));
    modal.show();

    // Start listening for progress updates
    startProgressStream(sessionId);
}

function startProgressStream(sessionId) {
    // Close existing connection if any
    if (progressEventSource) {
        progressEventSource.close();
    }

    progressEventSource = new EventSource(`/devices/progress-stream/${sessionId}`);

    progressEventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            handleProgressUpdate(data);
        } catch (error) {
            console.error('Error parsing progress data:', error);
        }
    };

    progressEventSource.onerror = function(error) {
        console.error('Progress stream error:', error);
        progressEventSource.close();
    };
}

function handleProgressUpdate(data) {
    switch(data.type) {
        case 'progress':
            updateProgressDisplay(data);
            break;
        case 'complete':
            handleCompletion(data);
            break;
        case 'error':
            handleError(data);
            break;
    }
}

function updateProgressDisplay(data) {
    // Update status
    let statusBadge = document.getElementById('currentStatus');
    statusBadge.textContent = formatStatus(data.status);

    switch(data.status) {
        case 'connecting':
            statusBadge.className = 'badge bg-warning';
            break;
        case 'connected':
            statusBadge.className = 'badge bg-info';
            break;
        case 'parsing':
            statusBadge.className = 'badge bg-primary';
            break;
        case 'updating_database':
            statusBadge.className = 'badge bg-primary';
            break;
        case 'completed':
            statusBadge.className = 'badge bg-success';
            break;
        case 'failed':
            statusBadge.className = 'badge bg-danger';
            break;
        default:
            statusBadge.className = 'badge bg-secondary';
    }

    // Update current command
    if (data.current_command) {
        document.getElementById('currentCommandSection').style.display = 'block';
        document.getElementById('currentCommand').textContent = data.current_command;
    }

    // Update commands list
    if (data.commands && data.commands.length > 0) {
        document.getElementById('commandsSection').style.display = 'block';
        updateCommandsList(data.commands);
    }

    // Show interfaces found if available
    if (data.interfaces_found > 0) {
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('interfacesCount').textContent = data.interfaces_found;
    }

    // Show error if present
    if (data.error) {
        document.getElementById('errorSection').style.display = 'block';
        document.getElementById('errorMessage').textContent = data.error;
    }
}

function updateCommandsList(commands) {
    const commandsList = document.getElementById('commandsList');
    commandsList.innerHTML = '';

    commands.forEach(command => {
        const commandDiv = document.createElement('div');
        commandDiv.className = 'command-item d-flex justify-content-between align-items-center py-1';

        const commandText = document.createElement('span');
        commandText.className = 'font-monospace';
        commandText.textContent = command.command;

        const statusSpan = document.createElement('span');
        switch(command.status) {
            case 'pending':
                statusSpan.innerHTML = '<i class="bi bi-clock text-muted"></i> Pending';
                break;
            case 'executing':
                statusSpan.innerHTML = '<i class="bi bi-arrow-repeat text-primary"></i> Running...';
                break;
            case 'completed':
                statusSpan.innerHTML = `<i class="bi bi-check-circle text-success"></i> Done (${command.output_length} chars)`;
                break;
            case 'failed':
                statusSpan.innerHTML = '<i class="bi bi-x-circle text-danger"></i> Failed';
                statusSpan.title = command.error || 'Unknown error';
                break;
        }

        commandDiv.appendChild(commandText);
        commandDiv.appendChild(statusSpan);
        commandsList.appendChild(commandDiv);
    });
}

function formatStatus(status) {
    const statusMap = {
        'starting': 'Starting...',
        'connecting': 'Connecting...',
        'connected': 'Connected',
        'parsing': 'Parsing Data',
        'updating_database': 'Updating Database',
        'completed': 'Completed',
        'failed': 'Failed'
    };
    return statusMap[status] || status;
}

function handleCompletion(data) {
    // Close progress stream
    if (progressEventSource) {
        progressEventSource.close();
        progressEventSource = null;
    }

    // Update final status
    document.getElementById('currentStatus').textContent = data.success ? 'Completed Successfully' : 'Failed';
    document.getElementById('currentStatus').className = data.success ? 'badge bg-success' : 'badge bg-danger';

    // Hide current command section
    document.getElementById('currentCommandSection').style.display = 'none';

    // Show final results
    if (data.success) {
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('interfacesCount').textContent = data.interfaces_found;
        document.getElementById('refreshButton').style.display = 'inline-block';
    }

    // Show error if failed
    if (!data.success && data.error) {
        document.getElementById('errorSection').style.display = 'block';
        document.getElementById('errorMessage').textContent = data.error;
    }
}

function handleError(data) {
    // Close progress stream
    if (progressEventSource) {
        progressEventSource.close();
        progressEventSource = null;
    }

    // Show error
    document.getElementById('currentStatus').textContent = 'Error';
    document.getElementById('currentStatus').className = 'badge bg-danger';
    document.getElementById('errorSection').style.display = 'block';
    document.getElementById('errorMessage').textContent = data.error;
}

function refreshPage() {
    window.location.reload();
}

function bulkCollect() {
    var selected = [];
    var checkboxes = document.querySelectorAll('.device-checkbox:checked');

    if (checkboxes.length === 0) {
        alert('Please select at least one device');
        return;
    }

    if (!confirm('Collect interfaces from ' + checkboxes.length + ' device(s)?')) {
        return;
    }

    // Create form and submit
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("devices.bulk_collect") }}';

    checkboxes.forEach(function(checkbox) {
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'device_ids[]';
        input.value = checkbox.value;
        form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
}

function updateBulkButtons() {
    var checkboxes = document.querySelectorAll('.device-checkbox:checked');
    var bulkCredentialBtn = document.getElementById('bulkCredentialBtn');
    var bulkVendorBtn = document.getElementById('bulkVendorBtn');

    if (checkboxes.length > 0) {
        bulkCredentialBtn.disabled = false;
        bulkVendorBtn.disabled = false;
    } else {
        bulkCredentialBtn.disabled = true;
        bulkVendorBtn.disabled = true;
    }
}

function showBulkCredentialModal() {
    var checkboxes = document.querySelectorAll('.device-checkbox:checked');

    if (checkboxes.length === 0) {
        alert('Please select at least one device');
        return;
    }

    // Update device count and list
    document.getElementById('selectedDeviceCount').textContent = checkboxes.length;

    var devicesList = document.getElementById('selectedDevicesList');
    devicesList.innerHTML = '';

    checkboxes.forEach(function(checkbox) {
        var row = checkbox.closest('tr');
        var hostname = row.cells[1].textContent.trim();
        var ipAddress = row.cells[2].textContent.trim();

        var listItem = document.createElement('li');
        listItem.innerHTML = `<small class="text-muted">${hostname} (${ipAddress})</small>`;
        devicesList.appendChild(listItem);
    });

    // Reset form
    document.getElementById('bulk_assignment_none').checked = true;
    toggleBulkCredentialOptions();

    // Show modal
    var modal = new bootstrap.Modal(document.getElementById('bulkCredentialModal'));
    modal.show();
}

function toggleBulkCredentialOptions() {
    var assignmentType = document.querySelector('input[name="bulk_assignment_type"]:checked').value;
    var credentialSelect = document.getElementById('bulk_credential_select');
    var poolSelect = document.getElementById('bulk_pool_select');

    // Hide both initially
    credentialSelect.style.display = 'none';
    poolSelect.style.display = 'none';

    // Show relevant option
    if (assignmentType === 'credential') {
        credentialSelect.style.display = 'block';
    } else if (assignmentType === 'pool') {
        poolSelect.style.display = 'block';
    }
}

function showBulkVendorModal() {
    var checkboxes = document.querySelectorAll('.device-checkbox:checked');

    if (checkboxes.length === 0) {
        alert('Please select at least one device');
        return;
    }

    // Update device count and list
    document.getElementById('selectedVendorDeviceCount').textContent = checkboxes.length;

    var devicesList = document.getElementById('selectedVendorDevicesList');
    devicesList.innerHTML = '';

    checkboxes.forEach(function(checkbox) {
        var row = checkbox.closest('tr');
        var hostname = row.cells[1].textContent.trim();
        var ipAddress = row.cells[2].textContent.trim();

        var listItem = document.createElement('li');
        listItem.innerHTML = `<small class="text-muted">${hostname} (${ipAddress})</small>`;
        devicesList.appendChild(listItem);
    });

    // Reset form
    document.getElementById('bulk_vendor').value = '';

    // Show modal
    var modal = new bootstrap.Modal(document.getElementById('bulkVendorModal'));
    modal.show();
}

// Handle bulk vendor form submission
document.getElementById('bulkVendorForm').addEventListener('submit', function(e) {
    e.preventDefault();

    var vendor = document.getElementById('bulk_vendor').value;
    if (!vendor) {
        alert('Please select a vendor');
        return;
    }

    var checkboxes = document.querySelectorAll('.device-checkbox:checked');
    var deviceIds = [];

    checkboxes.forEach(function(checkbox) {
        deviceIds.push(checkbox.value);
    });

    // Submit to backend
    fetch('{{ url_for("devices.bulk_edit_vendor") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            device_ids: deviceIds,
            vendor: vendor
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully updated vendor for ${data.updated_count} device(s)`);
            bootstrap.Modal.getInstance(document.getElementById('bulkVendorModal')).hide();
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error updating vendor: ' + error);
    });
});

function testDeviceConnection(deviceId, hostname) {
    // Disable button and show loading
    const button = event.target;
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-arrow-repeat spin"></i>';

    fetch(`/devices/${deviceId}/test-connection`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        // Restore button
        button.disabled = false;
        button.innerHTML = originalHtml;

        if (data.success) {
            alert(`✅ Connection to ${hostname} successful!\n\nCredential used: ${data.credential_name}\nConnection time: ${data.connection_time}ms`);
        } else {
            alert(`❌ Connection to ${hostname} failed!\n\nError: ${data.error}\n\nCredentials tried: ${data.credentials_tried || 0}`);
        }
    })
    .catch(error => {
        // Restore button
        button.disabled = false;
        button.innerHTML = originalHtml;

        alert(`❌ Error testing connection to ${hostname}\n\nError: ${error.message}`);
    });
}

// Clean up event source when page unloads
window.addEventListener('beforeunload', function() {
    if (progressEventSource) {
        progressEventSource.close();
    }
});
</script>
{% endblock %}