{% extends "base.html" %}

{% block title %}{{ device.hostname }} Interfaces - Network Device Manager{% endblock %}

{% block extra_css %}
<style>
    .table-card {
        border-radius: 0.5rem;
        border: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 1rem;
        transition: box-shadow 0.3s ease;
    }

    .table-card:hover {
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
    }

    .table-card .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
        padding: 0.6rem 0.85rem;
        border-radius: 0.5rem 0.5rem 0 0 !important;
    }

    .table-card .card-header h5 {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
        color: #495057;
    }

    .table-card .card-body {
        padding: 0.85rem;
    }

    .table-card table thead th {
        padding: 0.6rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #dee2e6;
        background: #f8f9fa;
    }

    .table-card table tbody td {
        padding: 0.5rem 0.5rem;
        font-size: 0.8125rem;
        vertical-align: middle;
    }

    .badge {
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
        font-weight: 500;
    }

    .btn-sm {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
    }

    .action-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .device-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
        font-size: 0.8125rem;
    }

    .device-info-item {
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 0.375rem;
    }

    .device-info-item strong {
        display: block;
        font-size: 0.7rem;
        text-transform: uppercase;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Completion Message (hidden by default) -->
<div id="completion-message" class="alert alert-dismissible fade show" role="alert" style="display: none;">
    <strong id="completion-title"></strong> <span id="completion-text"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<!-- Action Toolbar -->
<div class="action-toolbar">
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <a href="{{ url_for('interfaces.add_interface', device_id=device.id) }}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-circle"></i> Add Interface
        </a>
        <button type="button" class="btn btn-sm btn-success" onclick="collectInterfaces()">
            <i class="bi bi-arrow-repeat"></i> Collect Interfaces
        </button>
    </div>
    <a href="{{ url_for('devices.list_devices') }}" class="btn btn-sm btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Devices
    </a>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalLabel">
                    <i class="bi bi-arrow-repeat"></i> Collecting Interfaces from <span id="deviceHostname">{{ device.hostname }}</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Main Status -->
                <div class="mb-3">
                    <strong>Status:</strong> <span id="currentStatus" class="badge bg-info">Starting...</span>
                </div>

                <!-- Current Command -->
                <div class="mb-3" id="currentCommandSection" style="display: none;">
                    <strong>Current Command:</strong>
                    <div class="font-monospace text-muted" id="currentCommand"></div>
                </div>

                <!-- Commands Progress -->
                <div class="mb-3" id="commandsSection" style="display: none;">
                    <strong>Commands:</strong>
                    <div id="commandsList" class="mt-2"></div>
                </div>

                <!-- Results -->
                <div class="mb-3" id="resultsSection" style="display: none;">
                    <strong>Results:</strong>
                    <div class="alert alert-success">
                        Found <span id="interfacesCount">0</span> interfaces with IP addresses.
                    </div>
                </div>

                <!-- Error -->
                <div class="mb-3" id="errorSection" style="display: none;">
                    <div class="alert alert-danger">
                        <strong>Error:</strong> <span id="errorMessage"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeButton">Close</button>
                <button type="button" class="btn btn-primary" id="refreshButton" onclick="refreshPage()" style="display: none;">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Page
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Device Information Card -->
<div class="table-card mb-3">
    <div class="card-header">
        <h5>{{ device.hostname }} - Device Information</h5>
    </div>
    <div class="card-body">
        <div class="device-info-grid">
            <div class="device-info-item">
                <strong>Hostname</strong>
                {{ device.hostname }}
            </div>
            <div class="device-info-item">
                <strong>IP Address</strong>
                {{ device.ip_address }}
            </div>
            <div class="device-info-item">
                <strong>Vendor</strong>
                {{ device.vendor|replace('_', ' ')|title }}
            </div>
            <div class="device-info-item">
                <strong>Status</strong>
                {% if device.is_reachable %}
                <span class="badge bg-success">Reachable</span>
                {% else %}
                <span class="badge bg-danger" title="{{ device.last_error }}">Unreachable</span>
                {% endif %}
            </div>
            <div class="device-info-item">
                <strong>Last Check</strong>
                {{ device.last_reachability_check.strftime('%Y-%m-%d %H:%M') if device.last_reachability_check else 'Never' }}
            </div>
            <div class="device-info-item">
                <strong>Interface Count</strong>
                <span class="badge bg-primary">{{ interfaces|length }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Interfaces Table -->
<div class="table-card">
    <div class="card-header">
        <h5>Interfaces</h5>
    </div>
    <div class="card-body">
        {% if interfaces %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Interface Name</th>
                        <th>Description</th>
                        <th>IPv4 Address</th>
                        <th>IPv6 Address</th>
                        <th>Status</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for interface in interfaces %}
                    <tr>
                        <td>
                            <strong>{{ interface.name }}</strong>
                        </td>
                        <td>
                            <span class="text-muted">{{ interface.description or 'No description' }}</span>
                        </td>
                        <td>
                            {% if interface.ipv4_address %}
                            <code>{{ interface.ipv4_address }}</code>
                            {% else %}
                            <span class="text-muted">None</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if interface.ipv6_address %}
                            <code>{{ interface.ipv6_address }}</code>
                            {% else %}
                            <span class="text-muted">None</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if interface.status == 'up' or interface.status == 'up/up' %}
                            <span class="badge bg-success">{{ interface.status|title }}</span>
                            {% elif interface.status == 'down' or interface.status == 'down/down' %}
                            <span class="badge bg-danger">{{ interface.status|title }}</span>
                            {% elif interface.status == 'up/down' %}
                            <span class="badge bg-warning">{{ interface.status|title }}</span>
                            {% elif interface.status == 'administratively down' %}
                            <span class="badge bg-secondary">Admin Down</span>
                            {% else %}
                            <span class="badge bg-light text-dark">{{ interface.status|title }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ interface.last_updated.strftime('%Y-%m-%d %H:%M') if interface.last_updated else 'Never' }}
                            </small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ url_for('interfaces.edit_interface', interface_id=interface.id) }}"
                                   class="btn btn-outline-primary" title="Edit Interface">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" class="btn btn-outline-danger"
                                        onclick="deleteInterface({{ interface.id }}, '{{ interface.name }}')"
                                        title="Delete Interface">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-router text-muted" style="font-size: 2.5rem;"></i>
            <h5 class="mt-3 text-muted" style="font-size: 0.95rem;">No Interfaces Found</h5>
            <p class="text-muted" style="font-size: 0.8125rem;">This device has no interfaces configured or collected.</p>
            <div class="mt-3">
                <a href="{{ url_for('interfaces.add_interface', device_id=device.id) }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Interface Manually
                </a>
                <button type="button" class="btn btn-sm btn-success ms-2" onclick="collectInterfaces()">
                    <i class="bi bi-arrow-repeat"></i> Collect from Device
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Hidden form for deletions -->
<form id="deleteForm" method="POST" style="display: none;">
</form>
{% endblock %}

{% block extra_js %}
<script>
const deviceId = {{ device.id }};
const deviceHostname = '{{ device.hostname }}';
const showProgress = {{ 'true' if show_progress else 'false' }};

function deleteInterface(interfaceId, interfaceName) {
    if (confirm(`Are you sure you want to delete interface "${interfaceName}"?\n\nThis action cannot be undone.`)) {
        const form = document.getElementById('deleteForm');
        form.action = `/interfaces/${interfaceId}/delete`;
        form.submit();
    }
}

function collectInterfaces() {
    fetch(`/devices/${deviceId}/collect-progress`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.progress_enabled) {
            // Show modal and track progress via SSE
            showProgressModal(data.session_id);
        } else {
            // Show inline progress bar
            showInlineProgress();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error starting interface collection');
    });
}

let progressEventSource = null;

function showProgressModal(sessionId) {
    // Setup modal
    document.getElementById('deviceHostname').textContent = deviceHostname;
    document.getElementById('currentStatus').textContent = 'Starting...';
    document.getElementById('currentStatus').className = 'badge bg-info';

    // Hide all sections initially
    document.getElementById('currentCommandSection').style.display = 'none';
    document.getElementById('commandsSection').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('errorSection').style.display = 'none';
    document.getElementById('refreshButton').style.display = 'none';

    // Show modal
    const modalElement = document.getElementById('progressModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();

    // Start listening for progress updates
    startProgressStream(sessionId);
}

function startProgressStream(sessionId) {
    // Close existing connection if any
    if (progressEventSource) {
        progressEventSource.close();
    }

    progressEventSource = new EventSource(`/devices/progress-stream/${sessionId}`);

    progressEventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            handleProgressUpdate(data);
        } catch (error) {
            console.error('Error parsing progress data:', error);
        }
    };

    progressEventSource.onerror = function(error) {
        console.error('Progress stream error:', error);
        if (progressEventSource) {
            progressEventSource.close();
        }
    };
}

function handleProgressUpdate(data) {
    switch(data.type) {
        case 'progress':
            updateProgressDisplay(data);
            break;
        case 'complete':
            handleCompletion(data);
            break;
        case 'error':
            handleError(data);
            break;
    }
}

function updateProgressDisplay(data) {
    // Update status
    let statusBadge = document.getElementById('currentStatus');
    statusBadge.textContent = formatStatus(data.status);

    switch(data.status) {
        case 'connecting':
            statusBadge.className = 'badge bg-warning';
            break;
        case 'connected':
            statusBadge.className = 'badge bg-info';
            break;
        case 'parsing':
            statusBadge.className = 'badge bg-primary';
            break;
        case 'updating_database':
            statusBadge.className = 'badge bg-primary';
            break;
        case 'completed':
            statusBadge.className = 'badge bg-success';
            break;
        case 'failed':
            statusBadge.className = 'badge bg-danger';
            break;
        default:
            statusBadge.className = 'badge bg-secondary';
    }

    // Update current command
    if (data.current_command) {
        document.getElementById('currentCommandSection').style.display = 'block';
        document.getElementById('currentCommand').textContent = data.current_command;
    }

    // Update commands list
    if (data.commands && data.commands.length > 0) {
        document.getElementById('commandsSection').style.display = 'block';
        updateCommandsList(data.commands);
    }

    // Show interfaces found if available
    if (data.interfaces_found > 0) {
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('interfacesCount').textContent = data.interfaces_found;
    }

    // Show error if present
    if (data.error) {
        document.getElementById('errorSection').style.display = 'block';
        document.getElementById('errorMessage').textContent = data.error;
    }
}

function updateCommandsList(commands) {
    const commandsList = document.getElementById('commandsList');
    commandsList.innerHTML = '';

    commands.forEach(command => {
        const commandDiv = document.createElement('div');
        commandDiv.className = 'command-item d-flex justify-content-between align-items-center py-1';

        const commandText = document.createElement('span');
        commandText.className = 'font-monospace';
        commandText.textContent = command.command;

        const statusSpan = document.createElement('span');
        switch(command.status) {
            case 'pending':
                statusSpan.innerHTML = '<i class="bi bi-clock text-muted"></i> Pending';
                break;
            case 'executing':
                statusSpan.innerHTML = '<i class="bi bi-arrow-repeat text-primary"></i> Running...';
                break;
            case 'completed':
                statusSpan.innerHTML = `<i class="bi bi-check-circle text-success"></i> Done (${command.output_length} chars)`;
                break;
            case 'failed':
                statusSpan.innerHTML = '<i class="bi bi-x-circle text-danger"></i> Failed';
                statusSpan.title = command.error || 'Unknown error';
                break;
        }

        commandDiv.appendChild(commandText);
        commandDiv.appendChild(statusSpan);
        commandsList.appendChild(commandDiv);
    });
}

function formatStatus(status) {
    const statusMap = {
        'starting': 'Starting...',
        'connecting': 'Connecting...',
        'connected': 'Connected',
        'parsing': 'Parsing Data',
        'updating_database': 'Updating Database',
        'completed': 'Completed',
        'failed': 'Failed'
    };
    return statusMap[status] || status;
}

function handleCompletion(data) {
    // Close progress stream
    if (progressEventSource) {
        progressEventSource.close();
        progressEventSource = null;
    }

    // Update final status
    document.getElementById('currentStatus').textContent = data.success ? 'Completed Successfully' : 'Failed';
    document.getElementById('currentStatus').className = data.success ? 'badge bg-success' : 'badge bg-danger';

    // Hide current command section
    document.getElementById('currentCommandSection').style.display = 'none';

    // Show final results
    if (data.success) {
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('interfacesCount').textContent = data.interfaces_found;
        document.getElementById('refreshButton').style.display = 'inline-block';

        // Show completion message at top of page
        showCompletionMessage({
            success: true,
            interfaces_found: data.interfaces_found
        });
    }

    // Show error if failed
    if (!data.success && data.error) {
        document.getElementById('errorSection').style.display = 'block';
        document.getElementById('errorMessage').textContent = data.error;

        // Show error message at top
        showCompletionMessage({
            success: false,
            error: data.error
        });
    }
}

function handleError(data) {
    // Close progress stream
    if (progressEventSource) {
        progressEventSource.close();
        progressEventSource = null;
    }

    // Show error
    document.getElementById('currentStatus').textContent = 'Error';
    document.getElementById('currentStatus').className = 'badge bg-danger';
    document.getElementById('errorSection').style.display = 'block';
    document.getElementById('errorMessage').textContent = data.error || 'Unknown error occurred';

    // Show error message at top
    showCompletionMessage({
        success: false,
        error: data.error
    });
}

function refreshPage() {
    window.location.reload();
}

function showInlineProgress() {
    // Create inline progress bar in the device info card
    const deviceCard = document.querySelector('.table-card .card-body');
    const existingProgress = document.getElementById('inline-progress-container');

    if (existingProgress) {
        existingProgress.remove();
    }

    const progressContainer = document.createElement('div');
    progressContainer.id = 'inline-progress-container';
    progressContainer.className = 'mb-3';
    progressContainer.innerHTML = `
        <div class="progress" style="height: 25px;">
            <div id="inline-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                0%
            </div>
        </div>
        <small id="inline-progress-status" class="text-muted">Collecting interfaces...</small>
    `;

    deviceCard.insertBefore(progressContainer, deviceCard.firstChild);

    const progressBar = document.getElementById('inline-progress-bar');
    const progressStatus = document.getElementById('inline-progress-status');

    // Simulate progress from 0 to 90% over time
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;

        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressBar.textContent = Math.round(progress) + '%';

        if (progress >= 90) {
            clearInterval(interval);
            progressStatus.textContent = 'Finishing up...';
        }
    }, 500);

    // Make POST request to collect interfaces
    fetch(`/devices/${deviceId}/collect`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(interval);

        // Complete progress to 100%
        progressBar.style.width = '100%';
        progressBar.setAttribute('aria-valuenow', 100);
        progressBar.textContent = '100%';
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
        progressStatus.textContent = 'Complete!';

        // Show completion message at top of page
        showCompletionMessage(data);

        // Reload page after 2 seconds
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    })
    .catch(error => {
        clearInterval(interval);
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-danger');
        progressStatus.textContent = 'Error: ' + error.message;

        // Show error message
        showCompletionMessage({success: false, error: error.message});
    });
}

function showCompletionMessage(data) {
    const messageDiv = document.getElementById('completion-message');
    const titleSpan = document.getElementById('completion-title');
    const textSpan = document.getElementById('completion-text');

    if (data.success !== false) {
        messageDiv.className = 'alert alert-success alert-dismissible fade show';
        titleSpan.textContent = 'Success!';
        const interfaceCount = data.interfaces_found || 0;
        textSpan.textContent = `Collected ${interfaceCount} interface(s) from ${deviceHostname}`;
    } else {
        messageDiv.className = 'alert alert-danger alert-dismissible fade show';
        titleSpan.textContent = 'Error!';
        textSpan.textContent = `Failed to collect interfaces from ${deviceHostname}: ${data.error || 'Unknown error'}`;
    }

    messageDiv.style.display = 'block';

    // Scroll to top to show the message
    window.scrollTo({top: 0, behavior: 'smooth'});
}

// Auto-refresh hint
{% if device.is_reachable %}
document.addEventListener('DOMContentLoaded', function() {
    // Add a subtle hint about automatic refresh
    const lastCheck = '{{ device.last_reachability_check.strftime("%Y-%m-%d %H:%M") if device.last_reachability_check else "" }}';
    if (lastCheck) {
        const now = new Date();
        const checkTime = new Date(lastCheck);
        const diffMinutes = Math.floor((now - checkTime) / (1000 * 60));

        if (diffMinutes > 60) {
            // Show subtle suggestion to refresh if data is old
            const card = document.querySelector('.card-header h5');
            if (card) {
                card.innerHTML += ' <small class="text-muted">(Data is ' + diffMinutes + ' minutes old)</small>';
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}